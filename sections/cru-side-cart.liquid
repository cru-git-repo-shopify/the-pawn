<!-- Sidebar Cart -->
<div id="ajax-cart-sidebar" class="hidden fixed">
  <div id="cart-loading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center z-50">
    <div class="w-8 h-8 border-4 border-gray-300 border-t-black rounded-full animate-spin"></div>
  </div>
  <div class="side-cart-inner">
    <div class="side-cart-header">
      <h2 class="">Your Cart</h2>
      <button id="close-cart">&times;</button>
    </div>
    <div id="ajax-cart-items">
      <!-- Cart items will be dynamically inserted here -->
    </div>
    <div class="side-cart-footer">
      <div class="flex cart-totals">
        <span class="font-semibold">Subtotal:</span>
        <span id="ajax-cart-subtotal"></span>
      </div>
      <div class="side-cart-actions">
        <a href="/cart" class="cart-action">View Cart</a>
        <a href="/checkout" class="cart-action">Checkout</a>
      </div>
    </div>
  </div>
</div>

<!-- Cart Overlay -->
<div id="cart-overlay" class="hidden fixed inset-0 bg-black/50 z-40"></div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Open/Close Cart Sidebar
    const cartSidebar = document.getElementById('ajax-cart-sidebar');
    const overlay = document.getElementById('cart-overlay');
    const closeBtn = document.getElementById('close-cart');
    const openBtn = document.querySelector('.open-cart');
    const loadingOverlay = document.getElementById('cart-loading');

    openBtn.addEventListener('click', function() {
      cartSidebar.classList.remove('hidden');
      overlay.classList.remove('hidden');
    });

    closeBtn.addEventListener('click', closeCart);
    overlay.addEventListener('click', closeCart);

    function closeCart() {
      cartSidebar.classList.add('hidden');
      overlay.classList.add('hidden');
    }

    if (typeof Shopify === 'undefined') {
      var Shopify = {};
    }
    Shopify.formatMoney = function(cents) {
      return '$' + (cents / 100).toFixed(2);
    }

    function updateCart() {
      showLoading();
      fetch('/cart.js')
        .then(res => res.json())
        .then(cart => {
          const itemsContainer = document.getElementById('ajax-cart-items');
          const subtotal = document.getElementById('ajax-cart-subtotal');
          itemsContainer.innerHTML = '';

          if (cart.items.length === 0) {
            itemsContainer.innerHTML = '<p class="text-gray-500">Your cart is empty.</p>';
          } else {
            cart.items.forEach((item, index) => {
              itemsContainer.innerHTML += `
                <div class="flex items-start side-cart-item">
                  <div class="cart-item-details">
                    <div class="font-semibold cart-item-title">${item.product_title}</div>
                    <div class="price_info">
                      <div class="flex items-center side-cart-qty">
                        <div>${Shopify.formatMoney(item.line_price)} x </div>
                        <div class="qty_inner">
                          <button class="quantity-btn" data-line="${index + 1}" data-action="minus">-</button>
                          <input type="text" value="${item.quantity}" readonly class="side_cart_qty_input">
                          <button class="quantity-btn" data-line="${index + 1}" data-action="plus">+</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <img src="${item.image}" alt="${item.title}" class="w-16 h-16 object-cover border rounded">
                  <button 
                    class="text-red-500 hover:text-red-700 text-sm remove-cart-item"
                    data-line="${index + 1}"
                    title="Remove"
                  >âœ•</button>
                </div>
              `;
            });
          }

          subtotal.textContent = Shopify.formatMoney(cart.total_price);

          // Bind remove buttons
          document.querySelectorAll('.remove-cart-item').forEach(button => {
            button.addEventListener('click', function () {
              const line = this.getAttribute('data-line');

              fetch('/cart/change.js', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                body: JSON.stringify({
                  line: parseInt(line),
                  quantity: 0
                })
              })
              .then(res => res.json())
              .then(data => {
                updateCart();
              });
            });
          });
          document.querySelectorAll('.quantity-btn').forEach(button => {
            button.addEventListener('click', function () {
              const line = this.getAttribute('data-line');
              const action = this.getAttribute('data-action');
              const input = this.parentElement.querySelector('input');
              let currentQty = parseInt(input.value);

              if (action === 'minus' && currentQty > 1) {
                changeCartQuantity(line, currentQty - 1);
              }
              if (action === 'plus') {
                changeCartQuantity(line, currentQty + 1);
              }
            });
          })
          .finally(() => {
            hideLoading();
            disableCartButtons(false);
          });
        });
    }

    function changeCartQuantity(line, qty) {
      showLoading();
      fetch('/cart/change.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          line: parseInt(line),
          quantity: qty
        })
      })
      .then(res => res.json())
      .then(data => {
        updateCart();
      })
      .finally(() => {
        hideLoading();
        disableCartButtons(false);
      });
    }
  
  // Show/Hide loading spinner
  function showLoading() {
    loadingOverlay.classList.remove('hidden');
  }
  function hideLoading() {
    loadingOverlay.classList.add('hidden');
  }

  // Disable/enable all cart buttons
  function disableCartButtons(disabled) {
    document.querySelectorAll('.quantity-btn, .remove-cart-item').forEach(btn => {
      btn.disabled = disabled;
      btn.classList.toggle('opacity-50', disabled);
      btn.classList.toggle('cursor-not-allowed', disabled);
    });
  }

  updateCart(); // Initial cart update
  hideLoading();
    
});
</script>

{% schema %}
{
    "name": "CRU Side Cart",
    "settings": [],
    "presets": [
        {
            "name": "CRU Side Cart",
            "category": "Custom"
        }
    ]
}
{% endschema %}